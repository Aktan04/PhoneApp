@using MudBlazor
@using PhoneApp.BlazorApp.Models
@using PhoneApp.BlazorApp.Services
@inject UsersService UsersService

<MudPaper Elevation="2" Class="pa-4">

    <MudText Typo="Typo.h6" GutterBottom="true">
        Edit user
    </MudText>

    @if (!string.IsNullOrEmpty(error))
    {
        <MudAlert Severity="Severity.Error" Class="mb-3">
            @error
        </MudAlert>
    }

    <MudTextField Label="Name"
                  @bind-Value="model.Name"
                  Variant="Variant.Outlined"
                  FullWidth="true"
                  Class="mb-3" />

    <MudTextField Label="Email"
                  @bind-Value="model.Email"
                  Variant="Variant.Outlined"
                  FullWidth="true"
                  Class="mb-3" />

    <MudDatePicker Label="Date of birth"
                   @bind-Date="birthDate"
                   Variant="Variant.Outlined"
                   Class="mb-4" />

    <MudStack Direction="Row" Spacing="2">
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="Save">
            Save
        </MudButton>

        <MudButton Variant="Variant.Text"
                   OnClick="Cancel">
            Cancel
        </MudButton>
    </MudStack>

</MudPaper>

@code {
    [Parameter] public UserDto User { get; set; } = null!;
    [Parameter] public EventCallback OnSaved { get; set; }
    [Parameter] public EventCallback OnCanceled { get; set; }

    private UpdateUserRequest model = new();
    private DateTime? birthDate;
    private string error = "";

    protected override void OnParametersSet()
    {
        model = new UpdateUserRequest
        {
            Name = User.Name,
            Email = User.Email,
            DateOfBirth = User.DateOfBirth
        };

        birthDate = User.DateOfBirth.ToDateTime(TimeOnly.MinValue);
    }

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(model.Name) ||
            string.IsNullOrWhiteSpace(model.Email))
        {
            error = "Имя и Email обязательны";
            return;
        }

        if (birthDate == null)
        {
            error = "Дата рождения обязательна";
            return;
        }

        try
        {
            error = "";
            model.DateOfBirth = DateOnly.FromDateTime(birthDate.Value);

            await UsersService.UpdateAsync(User.Id, model);
            await OnSaved.InvokeAsync();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task Cancel()
    {
        await OnCanceled.InvokeAsync();
    }
}